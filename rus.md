## Содержание
- [Введение](#introduction)
- [Философский вопрос](#the-philosophical-question)
  - [Оценка полученных данных](#evaluating-the-data)
- [Вычисление времени отрисовки вашей страницы](#finding-your-page-render-weight)
- [Напоследок](#final-thoughts)
- [Ссылки](#references)

> **На заметку**: Это статья содержит числовые значения, зависящие от 
определённой сборки браузера. Со временем эти числа изменятся, как и 
представленные здесь данные.

<a id="introduction"></a>
# Введение

Если вы из тех людей, кто интересуется тем, [как работают браузеры][1], 
тогда вы уже знаете о нескольких потрясающих статьях, раскрывающих подробности 
операций рендеринга/композиции графического ускорителя Chrome. Прежде всего, 
["Ускоренный рендеринг в Chrome: Многоуровневая модель"][2] является отличным 
введением в то, как Chrome использует понятие слоя для отрисовки страниц. Для 
более глубокого погружения в статье 
["Графически ускоренная композиция в Chrome"][3] обсуждается то, как Chrome 
использует свои слои бок о бок с графическим ускорителем для отрисовки вашей 
страницы.

> Краткий пересказ этих статей состоит в том, что с помощью аппаратного 
ускорения Chrome отрисует вашу страницу, растеризуя элементы страницы в 
прямоугольные области. Затем эти кусочки передаются в графический ускоритель, 
где аппаратная часть завершит их отрисовку на экран. Этот процесс называется 
композицией (наложением). Chrome будет перемещать области в память и из 
памяти, основываясь на необходимости и эвристиках исполнения, которые могут 
меняться в зависимости от платформы.

<a id="the-philosophical-question"></a>
# Философский вопрос

Проведя много времени за написанием [программных растеризаторов][4] для нужд 
3D, для меня стало очевидным то, что некоторые [CSS-свойства][5] должны иметь 
различную производительность при отрисовке страницы. Например, растеризация 
маленького изображения на экран является совершенно иной алгоритмической 
операцией, нежели отрисовка тени произвольной формы. Таким образом возникает 
вопрос: **как различные CSS-своства влияют на время отрисовки вашей 
страницы?**

Моей целью было классифицировать большой набор CSS-свойств и значений по 
времени их отрисовки, чтобы мы могли получить понимание того, какие типы 
CSS-свойств являются более производительными, чем другие. Чтобы этого 
добиться, я с помощью жвачки и клейкой ленты соорудил систему для улучшения 
числовой различимости времени отрисовки CSS. Система работает следующим 
образом:

- Генерируется набор независимых HTML-страниц, каждая из которых содержит 
единственный DOM-элемент и некоторое сочетание применённых к нему CSS-свойств.
- Запускается некоторый скрипт, проделывающий следующие действия для каждой 
страницы:
  - Запустить Chrome
  - Загрузить страницу
  - Получить [Skia Picture][6] для страницы
  - Пропустить каждое полученное Skia Picture через [Skia Benchmark][6] для 
  получения временных замеров
- Вывести все замеры и подивиться на числа (важная часть процесса...)

> Программный пакет растеризации Chrome называется [SKIA][7], и он управляет 
не только растеризацией вашей веб-страницы, но также и всех нужд HTML5 Canvas 
API (блоки, линии, растровые заливки, тени, размытия, все вызовы Chrome 
для превращения DOM в пиксели). Чтобы облегчить отладку отрисовки, SKIA 
позволяет сохранить в файлах [Skia Picture (*.SKP)][6] записи о всех командах, 
использованных при отрисовке страницы.

Используя этот комплект, мы генерируем набор HTML-страниц, в котором каждая 
страница содержит уникальную комбинацию CSS-свойств и их значений, например, 
как эти два HTML-файла:

    <style>
    #example1 {
        background: url(foo.png) top left / 50% 60%;
        padding: 20px; 
        margin-top: 10px;
        margin-right: 20px; 
        text-align: center;
    }
    </style>
    <div id="example1">WOAH</div>

И другой, более сложный:

    <style>
    #example1 {
        background-color:#eee;
        box-shadow: 1px 2px 3px 4px black;
        border-radius: 50%;
        background: radial-gradient(circle closest-corner, white, black);
        padding: 20px; 
        margin-top: 10px;
        margin-right: 20px; 
        text-align: center;
    }
    </style>
    <div id="example1">WOAH</div>

Каждая страница затем загружается в **свежем** экземпляре Chrome (чтобы быть 
уверенными в том, что временные замеры не были как-либо искажены устаревшими 
состояниями при перезагрузке страницы), затем создается 
[Skia Picture (*.SKP)][6] для определения списка Skia-команд, использованных 
для её отрисовки. Как только для каждой страницы сгенерируются SKP-файлы, мы 
запускаем другую серию операций и пропускаем файлы *.SKP через приложение 
Skia Benchmark (собранное из [исходников Skia][8]), которое выводит среднее 
время, требующееся для отрисовки конкретной страницы.

## Оценка полученных данных

С этого момента у нас есть возможность составить грубую картину того, сколько 
времени требуется для отрисовки тех или иных наборов CSS-свойств. Мы даже 
можем начать упорядочивать CSS-свойства по производительности их отрисовки. 
Ниже приведен большой график, сделанный с помощью [Chrome 27 beta][9] и 
отображающий весь набор временных замеров из нашего процесса. Обратите 
внимание, что все эти данные могут меняться по мере того, как Chrome будет 
становиться быстрее и быстрее.

<!-- Image here -->

Каждая вертикальная черта представляет собой время отрисовки страницы с 
единственной комбинацией CSS-свойств (увеличено в 100 раз, истинный масштаб 
составляет всего [0, 1.56ms]). Здесь множество симпатичных линий, но в таком 
формате они в некоторой степени бесполезны. Нам нужно проанализировать 
данные, чтобы найти полезные тенденции.

Прежде всего мы находим подтверждение тому, что **некоторые CSS-свойства 
попросту дороже остальных в плане отрисовки**. Например, отрисовка тени для 
DOM-елемента включает в себя многопроходную операцию со сплайнами и другими 
богомерзкими штучками, в отличие от прозрачности, которую отрисовать легче.

<!-- Image here -->

Далее, интересно то, что, **CSS-свойства могут иметь большее время отрисовки 
в комбинации, нежели в сумме по отдельности**. С точки зрения наблюдателя 
это немного странно, мы обычно ожидаем, что A+B = C, а не 2,2C. В качестве 
примера - добавление `box-shadow` и `border-radius-stroke`:

<!-- Image here -->

**Что действительно интересно, так это то, что здесь имеет место не просто 
свойство `box-shadow` само по себе, а особое значение *permutation***. 
Например, ниже показывается комбинация `box-shadow: 50%` и `border-radius` с 
некоторыми разновидностями значений.

<!-- Image here -->

При взгляде на данные все кажется приемлемым. Существует множество нетичипных 
комбинаций, которых мой тестовый набор не затрагивает. Впереди еще тонны 
тестов и комбинаций, которые могут привести к интересным результатам.

<a id="finding-your-page-render-weight"></a>
# Вычисление времени отрисовки вашей страницы

Взяв на вооружение способность отслеживать время отрисовки каждого элемента 
на вашей странице, у разработчиков появляется возможность оценки времени 
отрисовки и его влияния на отзывчивость вашего сайта. Несколько рекомендаций 
о том, с чего начать:

- Используте [режим постоянной отрисовки][10] в Chrome Dev Tools, чтобы 
получить представление о том, чего вам стоят ваши CSS-свойства.
- Включите разбор CSS в ваш процесс анализа кода, чтобы отловить проблемы с 
производительностью. Ищите такие места в вашем CSS, где вы используете более 
дорогие вещи, такие как градиенты и тени. Спросите себя, действительно ли они 
там нужны?
- Если сомневаетесь, всегда заботьтесь о лучшей производительности. Ваши 
пользователи могут не запомнить отступ у столбцов на вашей странице, 
но они точно запомнят ощущение от посещения вашего сайта.

> К сожалению, на данный момент без ручной настройки комплекта, подобного 
нашему, сложно автоматизировать процесс вычисления времени отрисовки 
страницы, что усложняет достижение непрерывной интеграции для версий вашей 
страницы под разные платформы.

<a id="final-thoughts"></a>
# Напоследок

Одна из наиболее интересных вещей об этом эксперименте состоит в том, что 
временные замеры будут продолжать изменяться с каждой новой 
[версией Chrome][11] (и, надеюсь, ускоряться). "Браузерное" ПО - это все 
время изменяющаяся область. Что медленно сегодня, может ускориться завтра. 
Из этой статьи вы можете вынести то, что нужно избегать указания 
`box-shadow: 1px 2px 3px 4px` для элемента, у которого уже есть 
`border-radius: 5`. **Хотя, более значимым выводом будет то, что CSS-свойства 
напрямую влияют на время отрисовки вашей страницы**.

> Как и в случаях с любым ПО, удостоверьтесь в правильности ваших 
дизайнерских решений в отношении к целям производительности и платформам для 
определения их пригодности в ваших приложениях прежде, чем принимать эти 
решения.

<a id="references"></a>
# Ссылки

- [How browsers work][1]
- [Accelerated Rendering in Chrome: The Layer Model][2]
- [GPU Accelerated Compositing in Chrome][3]
- [Skia source code][8]
- [Skia Debugger][6]
- [GPU Accelerated Compositing in Chrome][3]
- [Chrome DevTools : Continuous Paint mode][10]

[1]: http://www.html5rocks.com/en/tutorials/internals/howbrowserswork/
[2]: http://www.html5rocks.com/en/tutorials/speed/layers/
[3]: http://www.chromium.org/developers/design-documents/gpu-accelerated-compositing-in-chrome
[4]: http://en.wikipedia.org/wiki/Software_rendering
[5]: http://docs.webplatform.org/wiki/css/properties
[6]: https://sites.google.com/site/skiadocs/developer-documentation/skia-debugger
[7]: http://www.chromium.org/developers/design-documents/graphics-and-skia
[8]: https://code.google.com/p/skia/
[9]: https://www.google.com/intl/en/chrome/browser/beta.html
[10]: http://updates.html5rocks.com/2013/02/Profiling-Long-Paint-Times-with-DevTools-Continuous-Painting-Mode
[11]: https://www.google.com/intl/en/chrome/browser/beta.html
